name: Build

on:
  workflow_dispatch:
    inputs:
      runner:
        description: 'Runner Label'
        required: false
        default: 'self-hosted' 
  schedule:
    - cron: '0 0 */3 * *'

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ inputs.runner || 'self-hosted' }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          clean: false

      - name: Update Sources (Force Sync)
        run: |
          echo ">>> Actualizando Vanadium..."
          cd vanadium
          git fetch --tags
          LATEST_VANADIUM=$(git tag | sort -V | tail -n1)
          git checkout $LATEST_VANADIUM
          echo "Vanadium version: $LATEST_VANADIUM"
          cd ..

          echo ">>> Actualizando Helium..."
          cd helium
          git remote set-url origin https://github.com/imputnet/helium.git
          git fetch origin
          git checkout main || git checkout master
          git reset --hard origin/main
          
          echo "Helium actualizado al commit:"
          git rev-parse HEAD
          cd ..

      - name: Set ENV
        run: | 
          chmod +x *.sh
          echo "unix_time=$(date +%s)" >> $GITHUB_ENV
      
      - name: Build
        env:
            DEBIAN_FRONTEND: noninteractive
            LOCAL_TEST_JKS: ${{ secrets.LOCAL_TEST_JKS }} 
            STORE_TEST_JKS: ${{ secrets.STORE_TEST_JKS }}
        run: |
          ./build.sh

      - name: Identify Output
        run: |
          APK_PATH=$(find chromium/src/out/Default/apks/release -name 'Chrome*.apk' | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "Error: No se encontrÃ³ el APK."
            exit 1
          fi
          VERSION=$(basename "$APK_PATH" .apk)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          mv "$APK_PATH" "Helium-$VERSION-arm64.apk"

      - name: Publish Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: v${{ env.VERSION }}-${{ env.unix_time }}
          name: Helium v${{ env.VERSION }} (ARM64)
          files: |
            Helium-$VERSION-arm64.apk
